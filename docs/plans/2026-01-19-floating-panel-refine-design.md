# 悬浮框与 Refine 多选改造设计

## 目标

在不破坏现有 MVP 稳定性的前提下：

- 修复悬浮框内容显示不完整的问题，允许固定内容下的自适应宽度
- 支持 5 个预设位置（上/下/左/右/中），录音激活即显示，完成粘贴后隐藏
- 录音激活时话筒图标改为绿色
- Refine 从单选改为多选，按固定顺序叠加提示词
- 关闭选项为互斥开关

## 现状

- 悬浮框横向长度不足，内容显示不完整
- 悬浮框位置固定，无法配置
- Refine 为单选模式

## 设计方案

### 悬浮框显示与位置

- **内容固定**：录音状态图标与文字、实时波形、录音时长
- **宽度策略**：随内容长度自适应伸缩，避免截断，但内容结构固定顺序
- **显示策略**：录音激活后显示，贯穿录音与处理阶段，粘贴成功后隐藏
- **失败提示**：模拟粘贴失败时不隐藏，显示“你可以在目标位置粘贴”，确保用户知晓结果在剪贴板中
- **位置设置**：提供 5 个预设位置（上/下/左/右/中），以当前屏幕可见区域为对齐基准，使用固定边距（建议 16–24 px）
- **多显示器**：优先在前台应用所在屏幕显示
- **颜色规则**：激活录音时话筒为绿色；处理中可保持绿色或中性色；失败提示时可切换为警告色以提升辨识度
- **MVP 约束**：当前阶段先通过菜单栏子菜单配置位置，设置页实现后再迁移到设置页面

### Refine 多选与关闭逻辑

- **多选模式**：提供「纠错」「标点」「润色」三个选项
- **固定叠加顺序**：纠错 → 标点 → 润色
- **提示词组合**：按固定顺序拼接子 prompt，生成最终 prompt
- **关闭互斥**：选择“关闭”时清空所有选项，并跳过 Refine（仅转写）；选中任意 Refine 选项时自动取消“关闭”
- **历史记录**：保存组合信息（如“纠错 + 标点”或“关闭”）

## 数据流

1. 录音结束 → 进入处理状态
2. Whisper 转写
3. 根据 Refine 选项决定是否调用 AFM
4. 写入剪贴板
5. 模拟粘贴
6. 成功则隐藏悬浮框；失败则提示“你可以在目标位置粘贴”并保持可见

## 错误处理

- **模拟粘贴失败**：提示用户手动粘贴
- **辅助功能权限缺失**：提示用户前往系统设置授权（用于模拟粘贴和全局快捷键）
- **Refine 不可用**：自动降级为仅转写

## 测试建议

- 悬浮框在 5 个位置显示正确，宽度自适应不截断
- 录音激活时话筒为绿色，处理阶段持续显示
- 成功粘贴后隐藏；失败时提示可见
- Refine 多选组合顺序固定且可预测
- “关闭”与其它选项互斥
- 历史记录正确标注组合名称
